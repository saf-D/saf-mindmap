<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAFmindmap - 智能思维导图生成器</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: {
primary: {
50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
800: '#115e59', 900: '#134e4a'
},
slate: { 850: '#1a2332' }
},
fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
}
}
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>

<style>
* { font-family: 'Inter', sans-serif; }
.glass {
background: rgba(255, 255, 255, 0.85);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid rgba(255, 255, 255, 0.3);
}
.dark .glass {
background: rgba(30, 41, 59, 0.85);
border: 1px solid rgba(255, 255, 255, 0.1);
}
.glass-dark {
background: rgba(26, 35, 50, 0.95);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid rgba(255, 255, 255, 0.1);
}
.textarea-custom::-webkit-scrollbar { width: 6px; }
.textarea-custom::-webkit-scrollbar-track { background: transparent; }
.textarea-custom::-webkit-scrollbar-thumb { background: rgba(20, 184, 166, 0.3); border-radius: 3px; }
.gradient-text {
background: linear-gradient(135deg, #14b8a6 0%, #0ea5e9 50%, #8b5cf6 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}
.dark .gradient-text {
background: linear-gradient(135deg, #5eead4 0%, #38bdf8 50%, #a78bfa 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
.btn-glow {
box-shadow: 0 0 20px rgba(20, 184, 166, 0.3);
transition: all 0.3s ease;
}
.btn-glow:hover {
box-shadow: 0 0 30px rgba(20, 184, 166, 0.5);
transform: translateY(-2px);
}
.float-animation { animation: float 6s ease-in-out infinite; }
@keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
.modal-overlay { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-content { animation: scaleIn 0.3s ease; }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.loader {
border: 3px solid #f3f3f3;
border-top: 3px solid #14b8a6;
border-radius: 50%;
width: 20px;
height: 20px;
animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Mind Map Node Styles */
.mindmap-node {
position: absolute;
padding: 8px 12px;
border-radius: 12px;
border: 2px solid;
background: white;
display: flex;
align-items: center;
justify-content: center;
text-align: left;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
transition: all 0.3s ease;
}
.mindmap-node:hover {
transform: scale(1.05);
z-index: 10;
box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.mindmap-node.root {
border-radius: 18px;
font-weight: bold;
color: white;
box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
/* Template: Minimal */
.template-minimal .mindmap-node { border: none; background: transparent; box-shadow: none; border-bottom: 2px solid; border-radius: 0; }
.template-minimal .mindmap-node.root { background: transparent; color: #334155; border-bottom: 3px solid; }
/* Template: Capsule */
.template-capsule .mindmap-node { border-radius: 50px; border: none; background: #f1f5f9; color: #334155; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
.template-capsule .mindmap-node.root { background: linear-gradient(135deg, #14b8a6, #0ea5e9); color: white; }

/* Dark Mode Adjustments for Nodes */
.dark .mindmap-node { background: #334155; border-color: #475569; color: #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.dark .mindmap-node.root { border-color: transparent; }
.dark .template-minimal .mindmap-node { background: transparent; border-color: #94a3b8; color: #e2e8f0; }
.dark .template-capsule .mindmap-node { background: #1e293b; color: #e2e8f0; }

.node-content {
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
max-width: 100%;
}
.katex { font-size: 1em; }

/* Cookie Banner */
.cookie-banner {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(15, 23, 42, 0.95);
backdrop-filter: blur(10px);
color: white;
padding: 1rem;
z-index: 9999;
transform: translateY(100%);
transition: transform 0.5s ease;
}
.cookie-banner.show {
transform: translateY(0);
}

/* Custom Checkbox */
.ai-checkbox-container {
display: flex;
align-items: center;
cursor: pointer;
user-select: none;
padding: 8px 12px;
border-radius: 12px;
background: rgba(20, 184, 166, 0.05);
border: 1px solid rgba(20, 184, 166, 0.2);
transition: all 0.3s;
}
.ai-checkbox-container:hover {
background: rgba(20, 184, 166, 0.1);
}
.ai-checkbox-container input {
position: absolute;
opacity: 0;
cursor: pointer;
height: 0;
width: 0;
}
.checkmark {
height: 20px;
width: 20px;
background-color: #fff;
border: 2px solid #cbd5e1;
border-radius: 6px;
margin-right: 10px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}
.ai-checkbox-container input:checked ~ .checkmark {
background-color: #14b8a6;
border-color: #14b8a6;
}
.checkmark:after {
content: "";
display: none;
width: 5px;
height: 10px;
border: solid white;
border-width: 0 2px 2px 0;
transform: rotate(45deg);
margin-bottom: 2px;
}
.ai-checkbox-container input:checked ~ .checkmark:after {
display: block;
}
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-100 via-slate-50 to-teal-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 relative overflow-x-hidden transition-colors duration-500">
<!-- Background Decorations -->
<div class="fixed inset-0 overflow-hidden pointer-events-none">
<div class="absolute top-20 left-10 w-72 h-72 bg-teal-200 dark:bg-teal-900 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-30 float-animation"></div>
<div class="absolute top-40 right-20 w-96 h-96 bg-cyan-200 dark:bg-cyan-900 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-30 float-animation" style="animation-delay: -2s;"></div>
<div class="absolute bottom-20 left-1/3 w-80 h-80 bg-purple-200 dark:bg-purple-900 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-30 float-animation" style="animation-delay: -4s;"></div>
</div>

<!-- Header -->
<header class="relative z-10 py-6 px-4">
<div class="max-w-7xl mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center shadow-lg">
<i class="fas fa-sitemap text-white text-xl"></i>
</div>
<div>
<h1 class="text-2xl font-bold gradient-text">SAFmindmap</h1>
<p class="text-xs text-slate-500 dark:text-slate-400">智能思维导图生成器</p>
</div>
</div>
<div class="flex items-center gap-2">
<button id="historyBtn" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-teal-600 transition-all hover:scale-105" title="历史记录">
<i class="fas fa-history"></i>
</button>
<button id="darkModeToggle" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-teal-600 transition-all hover:scale-105" title="切换主题">
<i class="fas fa-moon dark:hidden"></i>
<i class="fas fa-sun hidden dark:inline"></i>
</button>
<button id="settingsBtn" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-teal-600 transition-all hover:scale-105" title="API 设置">
<i class="fas fa-key"></i>
</button>
<button id="helpBtn" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-teal-600 transition-all hover:scale-105" title="帮助">
<i class="fas fa-question"></i>
</button>
</div>
</div>
</header>

<!-- Main Content -->
<main class="relative z-10 px-4 pb-8">
<div class="max-w-7xl mx-auto">
<!-- Hero Section -->
<div class="text-center mb-8">
<h2 class="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-100 mb-4">
将思维<span class="gradient-text">可视化</span>
</h2>
<p class="text-slate-500 dark:text-slate-400 text-lg max-w-2xl mx-auto">
支持 Markdown、LaTeX 公式，可选 AI 智能解析，多种精美模板
</p>
</div>

<!-- API Status Bar -->
<div id="apiStatus" class="hidden mb-4 glass rounded-xl px-4 py-2 flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
<span class="w-2 h-2 rounded-full bg-green-500"></span>
<span>ChatGLM API 已连接</span>
</div>

<!-- Main Container -->
<div class="grid lg:grid-cols-2 gap-6">
<!-- Input Panel -->
<div class="glass rounded-3xl p-6 shadow-xl">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
<i class="fas fa-edit text-teal-500"></i>
输入文本
</h3>
<div class="flex gap-2">
<button id="clearBtn" class="px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-sm hover:bg-slate-200 dark:hover:bg-slate-600 transition-all">
<i class="fas fa-eraser mr-1"></i>清空
</button>
<button id="exampleBtn" class="px-3 py-1.5 rounded-lg bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 text-sm hover:bg-teal-200 dark:hover:bg-teal-800 transition-all">
<i class="fas fa-lightbulb mr-1"></i>示例
</button>
</div>
</div>
<textarea 
id="inputText" 
class="textarea-custom w-full h-64 p-4 rounded-2xl bg-slate-50/80 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm leading-relaxed resize-none focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-transparent transition-all"
placeholder="支持 Markdown 和 LaTeX 公式...

示例：
# 数学公式
- 物理定律
  - 质能方程 $E=mc^2$"></textarea>

<!-- AI Option Checkbox -->
<div class="mt-4">
<label class="ai-checkbox-container" id="aiCheckboxLabel">
<input type="checkbox" id="useAiCheckbox">
<span class="checkmark"></span>
<span class="text-sm text-slate-700 dark:text-slate-300 font-medium">启用 AI 智能解析 (需 API Key)</span>
</label>
</div>

<!-- Action Buttons -->
<div class="mt-4 space-y-3">
<button id="generateBtn" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-semibold btn-glow flex items-center justify-center gap-2">
<i class="fas fa-project-diagram"></i>
生成思维导图
</button>
<!-- AI Enhance Button (Hidden by default) -->
<button id="aiEnhanceBtn" class="hidden w-full py-2.5 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium hover:from-purple-600 hover:to-pink-600 transition-all flex items-center justify-center gap-2 text-sm">
<i class="fas fa-magic"></i>
AI 完善内容
</button>
</div>

<!-- Options -->
<div class="mt-4 grid grid-cols-2 gap-3">
<div class="flex flex-col gap-1">
<label class="text-xs text-slate-500 dark:text-slate-400">配色方案</label>
<select id="colorScheme" class="w-full px-3 py-2 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400">
<option value="teal">青绿</option>
<option value="blue">蓝色</option>
<option value="purple">紫色</option>
<option value="orange">橙色</option>
<option value="rainbow">彩虹</option>
</select>
</div>
<div class="flex flex-col gap-1">
<label class="text-xs text-slate-500 dark:text-slate-400">模板样式</label>
<select id="templateStyle" class="w-full px-3 py-2 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-teal-400">
<option value="classic">经典</option>
<option value="minimal">简约</option>
<option value="capsule">胶囊</option>
</select>
</div>
</div>
</div>

<!-- Output Panel -->
<div class="glass rounded-3xl p-6 shadow-xl">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
<i class="fas fa-image text-teal-500"></i>
导图预览
</h3>
<div class="flex gap-2">
<button id="zoomOut" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center" title="缩小"><i class="fas fa-search-minus text-sm"></i></button>
<button id="resetZoom" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center" title="重置"><i class="fas fa-compress text-sm"></i></button>
<button id="zoomIn" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center" title="放大"><i class="fas fa-search-plus text-sm"></i></button>
<button id="maximizeBtn" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center" title="最大化"><i class="fas fa-expand text-sm"></i></button>
</div>
</div>
<div id="canvasContainer" class="relative w-full h-80 rounded-2xl bg-slate-50/80 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 overflow-hidden">
<div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500">
<i class="fas fa-sitemap text-6xl mb-4 opacity-30"></i>
<p class="text-sm">输入文本后点击生成</p>
</div>
<div id="loadingState" class="absolute inset-0 hidden flex-col items-center justify-center bg-white/80 dark:bg-slate-900/80 z-10">
<div class="loader mb-3"></div>
<p class="text-sm text-slate-600 dark:text-slate-300" id="loadingText">AI 正在思考中...</p>
</div>
<div id="canvasWrapper" class="absolute inset-0 hidden overflow-auto bg-white dark:bg-slate-900">
<div id="mindMapRoot" class="relative origin-top-left min-w-full min-h-full template-classic" style="padding: 40px;">
<svg id="linesSvg" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="overflow: visible;"></svg>
</div>
</div>
</div>

<!-- Export Options -->
<div class="mt-4 flex gap-3">
<button id="downloadPng" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-slate-700 to-slate-800 text-white font-medium hover:from-slate-800 hover:to-slate-900 transition-all flex items-center justify-center gap-2 disabled:opacity-50" disabled>
<i class="fas fa-download"></i> 下载 PNG
</button>
<button id="downloadSvg" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium hover:from-purple-600 hover:to-pink-600 transition-all flex items-center justify-center gap-2 disabled:opacity-50" disabled>
<i class="fas fa-file-code"></i> 下载 SVG
</button>
</div>
</div>
</div>
</div>
</main>

<!-- Cookie Banner -->
<div id="cookieBanner" class="cookie-banner">
<div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
<div class="flex items-start gap-3">
<i class="fas fa-cookie-bite text-teal-400 text-2xl mt-1"></i>
<div>
<h4 class="font-semibold text-white">Cookie 使用说明</h4>
<p class="text-sm text-slate-300">我们使用本地存储保存您的 API Key 和历史记录，以提供更好的体验。数据仅保存在您的浏览器中。</p>
</div>
</div>
<div class="flex gap-3">
<button id="declineCookies" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 text-sm transition-all">拒绝 (无历史记录)</button>
<button id="acceptCookies" class="px-4 py-2 rounded-lg bg-teal-500 text-white hover:bg-teal-600 text-sm transition-all">接受</button>
</div>
</div>
</div>

<!-- History Sidebar -->
<div id="historySidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
<div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
<h3 class="font-semibold text-slate-800 dark:text-white">历史记录</h3>
<button id="closeHistory" class="text-slate-500 hover:text-slate-700 dark:hover:text-white"><i class="fas fa-times"></i></button>
</div>
<div id="historyList" class="p-4 space-y-3 overflow-y-auto" style="height: calc(100% - 60px);">
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
<div class="glass-dark rounded-3xl p-6 max-w-md w-full modal-content">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-semibold text-white">API 设置</h3>
<button id="closeSettings" class="w-8 h-8 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-all flex items-center justify-center">
<i class="fas fa-times"></i>
</button>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm text-slate-300 mb-2">ChatGLM API Key</label>
<input type="password" id="apiKeyInput" class="w-full px-4 py-3 rounded-xl bg-slate-800/50 border border-slate-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="请输入您的 API Key">
<p class="text-xs text-slate-500 mt-2">获取方式：访问智谱 AI 开放平台 open.bigmodel.cn</p>
</div>
<button id="saveApiKey" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-medium hover:from-teal-600 hover:to-cyan-600 transition-all">
保存设置
</button>
</div>
</div>
</div>

<!-- Fullscreen Modal -->
<div id="fullscreenModal" class="fixed inset-0 z-50 hidden">
<div class="absolute inset-0 bg-slate-900/90 dark:bg-black/90 backdrop-blur-sm modal-overlay"></div>
<div class="absolute inset-4 md:inset-8 glass-dark rounded-3xl overflow-hidden modal-content flex flex-col">
<div class="flex items-center justify-between p-4 border-b border-white/10">
<h3 class="text-lg font-semibold text-white flex items-center gap-2">
<i class="fas fa-expand text-teal-400"></i> 全屏预览
</h3>
<div class="flex items-center gap-2">
<button id="fsZoomOut" class="w-8 h-8 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-all flex items-center justify-center"><i class="fas fa-search-minus text-sm"></i></button>
<span id="fsZoomLevel" class="text-white/70 text-sm min-w-[50px] text-center">100%</span>
<button id="fsZoomIn" class="w-8 h-8 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-all flex items-center justify-center"><i class="fas fa-search-plus text-sm"></i></button>
<div class="w-px h-6 bg-white/20 mx-2"></div>
<button id="closeFullscreen" class="w-8 h-8 rounded-lg bg-white/10 text-white hover:bg-red-500/50 transition-all flex items-center justify-center"><i class="fas fa-times text-sm"></i></button>
</div>
</div>
<div id="fullscreenCanvasWrapper" class="flex-1 overflow-auto p-4 bg-slate-800">
<div id="mindMapRootFs" class="relative origin-top-left min-w-full min-h-full" style="padding: 40px;">
<svg id="linesSvgFs" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="overflow: visible;"></svg>
</div>
</div>
</div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
<div class="glass-dark rounded-3xl p-6 max-w-lg w-full max-h-[80vh] overflow-auto">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-semibold text-white">使用帮助</h3>
<button id="closeHelp" class="w-8 h-8 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
</div>
<div class="space-y-4 text-slate-300 text-sm">
<div>
<h4 class="font-semibold text-white mb-2">AI 功能说明</h4>
<p class="text-slate-400">
<b>本地模式 (默认)：</b>无需 API Key，直接解析 Markdown 和缩进文本。<br>
<b>AI 模式 (勾选)：</b>需填写 API Key，适合解析复杂自然语言或让 AI 帮您完善内容。
</p>
</div>
<div>
<h4 class="font-semibold text-white mb-2">模板样式</h4>
<ul class="list-disc list-inside space-y-1 text-slate-400">
<li><b>经典</b>：圆角卡片，适合大多数场景</li>
<li><b>简约</b>：无边框线条风格，简洁清晰</li>
<li><b>胶囊</b>：圆润胶囊形状，活泼现代</li>
</ul>
</div>
</div>
</div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
<div class="glass-dark rounded-xl px-4 py-3 flex items-center gap-3">
<i class="fas fa-check-circle text-teal-400"></i>
<span id="toastMessage" class="text-white text-sm"></span>
</div>
</div>

<script>
// State
let mindMapData = null;
let currentZoom = 1;
let fsZoom = 1;
let apiKey = '';
let cookieConsent = false;
let history = [];

// Color Schemes
const colorSchemes = {
teal: { primary: '#14b8a6', gradient: ['#0d9488', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4'] },
blue: { primary: '#3b82f6', gradient: ['#1d4ed8', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd'] },
purple: { primary: '#8b5cf6', gradient: ['#6d28d9', '#7c3aed', '#8b5cf6', '#a78bfa', '#c4b5fd'] },
orange: { primary: '#f97316', gradient: ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#fdba74'] },
rainbow: { primary: '#14b8a6', gradient: ['#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899', '#f97316'] }
};

const exampleText = `# 数学与物理
- 经典力学
  - 牛顿第一定律
  - 质能方程 $E=mc^2$
- 微积分基础
  - 导数定义 $f'(x)=\\lim_{\\Delta x \\to 0} \\frac{f(x+\\Delta x)-f(x)}{\\Delta x}$`;

// Initialize
function init() {
// Check Cookie Consent
const consent = localStorage.getItem('cookie_consent');
if (consent === 'true') {
cookieConsent = true;
apiKey = localStorage.getItem('chatglm_api_key') || '';
loadHistory();
initApiStatus();
} else if (consent === 'false') {
// Denied
} else {
// Show banner
setTimeout(() => {
document.getElementById('cookieBanner').classList.add('show');
}, 1000);
}
updateUIState();
initDarkMode();
}

function initApiStatus() {
if (apiKey) {
document.getElementById('apiStatus').classList.remove('hidden');
document.getElementById('apiStatus').classList.add('flex');
}
}

function initDarkMode() {
if (localStorage.getItem('darkMode') === 'true') {
document.documentElement.classList.add('dark');
}
}

// Update UI based on Checkbox and API Key
function updateUIState() {
const isAiChecked = document.getElementById('useAiCheckbox').checked;
const enhanceBtn = document.getElementById('aiEnhanceBtn');

if (isAiChecked) {
enhanceBtn.classList.remove('hidden');
} else {
enhanceBtn.classList.add('hidden');
}
}

function loadHistory() {
const h = localStorage.getItem('mindmap_history');
if (h) {
try { history = JSON.parse(h); } catch (e) { history = []; }
}
renderHistoryList();
}

// Cookie Consent Handlers
document.getElementById('acceptCookies').addEventListener('click', () => {
localStorage.setItem('cookie_consent', 'true');
cookieConsent = true;
document.getElementById('cookieBanner').classList.remove('show');
apiKey = localStorage.getItem('chatglm_api_key') || '';
loadHistory();
initApiStatus();
updateUIState();
});

document.getElementById('declineCookies').addEventListener('click', () => {
localStorage.setItem('cookie_consent', 'false');
cookieConsent = false;
document.getElementById('cookieBanner').classList.remove('show');
localStorage.removeItem('chatglm_api_key');
localStorage.removeItem('mindmap_history');
apiKey = '';
updateUIState();
});

// Dark Mode Toggle
document.getElementById('darkModeToggle').addEventListener('click', () => {
const isDark = document.documentElement.classList.toggle('dark');
if (cookieConsent) {
localStorage.setItem('darkMode', isDark);
}
});

// AI Checkbox Toggle
document.getElementById('useAiCheckbox').addEventListener('change', updateUIState);

// History Sidebar
document.getElementById('historyBtn').addEventListener('click', () => {
document.getElementById('historySidebar').classList.remove('translate-x-full');
});
document.getElementById('closeHistory').addEventListener('click', () => {
document.getElementById('historySidebar').classList.add('translate-x-full');
});

function saveToHistory(text, template, color) {
if (!cookieConsent) return;
const item = {
id: Date.now(),
text: text,
template: template,
color: color,
timestamp: new Date().toLocaleString('zh-CN')
};
history.unshift(item);
if (history.length > 20) history.pop();
localStorage.setItem('mindmap_history', JSON.stringify(history));
renderHistoryList();
}

function renderHistoryList() {
const list = document.getElementById('historyList');
if (!cookieConsent) {
list.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">未启用本地存储</div>';
return;
}
if (history.length === 0) {
list.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">暂无历史记录</div>';
return;
}
list.innerHTML = history.map(item => `
<div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-all group relative" onclick="loadHistoryItem(${item.id})">
<div class="text-xs text-slate-400 mb-1">${item.timestamp}</div>
<div class="text-sm text-slate-700 dark:text-slate-200 truncate">${item.text.substring(0, 50)}...</div>
<button onclick="event.stopPropagation(); deleteHistoryItem(${item.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
<i class="fas fa-trash-alt text-xs"></i>
</button>
</div>
`).join('');
}

window.loadHistoryItem = function(id) {
const item = history.find(h => h.id === id);
if (item) {
document.getElementById('inputText').value = item.text;
document.getElementById('templateStyle').value = item.template;
document.getElementById('colorScheme').value = item.color;
mindMapData = parseMarkdown(item.text);
renderMindMapDOM();
showToast('已加载历史记录');
document.getElementById('historySidebar').classList.add('translate-x-full');
}
}

window.deleteHistoryItem = function(id) {
history = history.filter(h => h.id !== id);
localStorage.setItem('mindmap_history', JSON.stringify(history));
renderHistoryList();
showToast('已删除');
}

// Show toast
function showToast(message) {
const toast = document.getElementById('toast');
document.getElementById('toastMessage').textContent = message;
toast.classList.remove('translate-y-20', 'opacity-0');
toast.classList.add('translate-y-0', 'opacity-100');
setTimeout(() => {
toast.classList.add('translate-y-20', 'opacity-0');
toast.classList.remove('translate-y-0', 'opacity-100');
}, 3000);
}

// Toggle loading state
function setLoading(isLoading, text = 'AI 正在思考中...') {
const loadingState = document.getElementById('loadingState');
const emptyState = document.getElementById('emptyState');
const wrapper = document.getElementById('canvasWrapper');

if (isLoading) {
loadingState.classList.remove('hidden');
loadingState.classList.add('flex');
document.getElementById('loadingText').textContent = text;
emptyState.classList.add('hidden');
wrapper.classList.add('hidden');
} else {
loadingState.classList.add('hidden');
loadingState.classList.remove('flex');
}
}

// ChatGLM API Call
async function callChatGLM(prompt, tools) {
if (!apiKey) {
showToast('请先设置 API Key');
return null;
}

try {
const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${apiKey}`
},
body: JSON.stringify({
model: 'glm-4',
messages: [{ role: 'user', content: prompt }],
tools: tools,
tool_choice: tools ? "auto" : null
})
});

if (!response.ok) throw new Error('API 请求失败');
const data = await response.json();
return data;
} catch (error) {
console.error('API Error:', error);
showToast('API 调用失败: ' + error.message);
return null;
}
}

// AI Enhance Content
async function aiEnhanceContent() {
const text = document.getElementById('inputText').value.trim();
if (!text) {
showToast('请输入内容');
return;
}
if(!apiKey) {
showToast('请先设置 API Key');
return;
}

setLoading(true, 'AI 正在完善内容...');
const prompt = `请完善并补充以下思维导图内容，使其更加丰富和专业。保持原有层级结构，适当增加细节。直接输出 Markdown 格式，不要有多余解释。\n\n原始内容：\n${text}`;

const result = await callChatGLM(prompt, null);
setLoading(false);

if (result && result.choices && result.choices[0]) {
document.getElementById('inputText').value = result.choices[0].message.content;
showToast('内容已完善');
}
}

// AI Generate Mind Map Structure
async function aiGenerateMindMap() {
const text = document.getElementById('inputText').value.trim();
if (!text) {
showToast('请输入内容');
return;
}

setLoading(true, 'AI 正在解析结构...');

const tools = [{
type: "function",
function: {
name: "GenerateMindMap",
description: "将文本内容转换为结构化的思维导图JSON格式",
parameters: {
type: "object",
properties: {
root: {
type: "object",
description: "思维导图的根节点",
properties: {
text: { type: "string", description: "节点文本" },
children: { type: "array", items: { "$ref": "#/definitions/Node" } }
},
required: ["text"]
}
},
required: ["root"],
definitions: {
Node: {
type: "object",
properties: {
text: { type: "string" },
children: { type: "array", items: { "$ref": "#/definitions/Node" } }
},
required: ["text"]
}
}
}
}
}];

const prompt = `请分析以下文本，提取核心结构并生成思维导图。忽略无关描述，只保留关键信息。如果包含LaTeX公式，请原样保留。\n\n文本内容：\n${text}`;

const result = await callChatGLM(prompt, tools);

if (result && result.choices && result.choices[0]) {
const message = result.choices[0].message;
if (message.tool_calls && message.tool_calls.length > 0) {
try {
const args = JSON.parse(message.tool_calls[0].function.arguments);
mindMapData = args.root;
renderMindMapDOM();
saveHistory();
setLoading(false);
showToast('AI 生成成功');
return;
} catch (e) {
console.error('Parse error:', e);
// Try to parse as normal markdown if JSON fails
mindMapData = parseMarkdown(message.content);
if(mindMapData) {
renderMindMapDOM();
saveHistory();
setLoading(false);
showToast('AI 生成成功 (文本模式)');
return;
}
showToast('AI 返回格式解析错误');
setLoading(false);
return;
}
} else if (message.content) {
// Fallback: parse the text content directly
mindMapData = parseMarkdown(message.content);
if(mindMapData) {
renderMindMapDOM();
saveHistory();
setLoading(false);
showToast('AI 生成成功 (文本模式)');
return;
}
}
}

// If we reach here, something went wrong with AI
setLoading(false);
showToast('AI 解析失败，请检查 API Key 或稍后重试');
}

// Local Markdown Parser - Robust Version
function parseMarkdown(text) {
try {
const lines = text.split('\n').filter(line => line.trim());
if (lines.length === 0) return null;

const root = { text: '思维导图', children: [], depth: -1 };
const stack = [root];
let baseDepth = -1; 

const headerRegex = /^(#{1,6})\s+(.+)$/;
// Support list with or without space after symbol: "- item" or "-item"
const listRegex = /^(\s*)([-*+]|\d+\.)\s*(.+)$/;

lines.forEach(line => {
let depth = 0;
let textContent = '';

const headerMatch = line.match(headerRegex);
if (headerMatch) {
const level = headerMatch[1].length;
depth = level - 1; 
textContent = headerMatch[2].trim();
baseDepth = depth; 
} else {
const listMatch = line.match(listRegex);
if (listMatch) {
const indent = listMatch[1].replace(/\t/g, '  ').length;
depth = baseDepth + 1 + Math.floor(indent / 2);
textContent = listMatch[3].trim();
} else {
// Plain text with indent
const indentMatch = line.match(/^(\s*)(.+)$/);
if (indentMatch) {
const indent = indentMatch[1].replace(/\t/g, '  ').length;
depth = baseDepth + 1 + Math.floor(indent / 2);
textContent = indentMatch[2].trim();
}
}
}

// Clean markdown bold syntax
if (textContent.includes('**')) {
textContent = textContent.replace(/\*\*(.+?)\*\*/g, '$1');
}

if (!textContent) return;

const node = { text: textContent, children: [], depth };

// Find correct parent
while (stack.length > 1 && stack[stack.length - 1].depth >= depth) {
stack.pop();
}

stack[stack.length - 1].children.push(node);
stack.push(node);
});

return root.children[0] || root;
} catch (e) {
console.error("Parse Error:", e);
showToast("解析错误: " + e.message);
return null;
}
}

// Calculate tree stats
function getTreeStats(node, depth = 0) {
let stats = { nodes: 1, maxDepth: depth, branches: node.children.length, chars: node.text.length };
node.children.forEach(child => {
const childStats = getTreeStats(child, depth + 1);
stats.nodes += childStats.nodes;
stats.maxDepth = Math.max(stats.maxDepth, childStats.maxDepth);
stats.branches += childStats.branches;
stats.chars += childStats.chars;
});
return stats;
}

// Layout calculation
function calculateLayout(node, x, y, config) {
const nodeWidth = 160;
const nodeHeight = 40;
const horizontalGap = 80;
const verticalGap = 15;

const estimatedWidth = Math.min(300, Math.max(nodeWidth, node.text.length * 10));

const pos = {
x, y, text: node.text, depth: node.depth || 0,
children: [], width: estimatedWidth, height: nodeHeight, subtreeHeight: 0
};

if (node.children && node.children.length > 0) {
let totalHeight = 0;
node.children.forEach((child, i) => {
const childPos = calculateLayout(child, x + estimatedWidth + horizontalGap, 0, config);
pos.children.push(childPos);
totalHeight += childPos.subtreeHeight;
if (i < node.children.length - 1) totalHeight += verticalGap;
});
pos.subtreeHeight = Math.max(nodeHeight, totalHeight);
} else {
pos.subtreeHeight = nodeHeight;
}

return pos;
}

function assignYPositions(pos, centerY) {
pos.y = centerY;
if (pos.children.length > 0) {
let currentY = centerY - pos.subtreeHeight / 2;
pos.children.forEach(child => {
assignYPositions(child, currentY + child.subtreeHeight / 2);
currentY += child.subtreeHeight + 15;
});
}
}

// DOM Rendering
function renderMindMapDOM(targetId = 'mindMapRoot', svgId = 'linesSvg') {
if (!mindMapData) {
showToast("无法渲染：数据为空");
return;
}

try {
const container = document.getElementById(targetId);
const svg = document.getElementById(svgId);
const scheme = colorSchemes[document.getElementById('colorScheme').value];
const template = document.getElementById('templateStyle').value;

container.className = `relative origin-top-left min-w-full min-h-full template-${template}`;
container.style.padding = '40px';

container.querySelectorAll('.mindmap-node').forEach(n => n.remove());
svg.innerHTML = '';

const rootPos = calculateLayout(mindMapData, 0, 0, {});
assignYPositions(rootPos, rootPos.subtreeHeight / 2);

let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = Infinity;
function findBounds(pos) {
minX = Math.min(minX, pos.x);
maxX = Math.max(maxX, pos.x + pos.width);
minY = Math.min(minY, pos.y - pos.height / 2);
maxY = Math.max(maxY, pos.y + pos.height / 2);
pos.children.forEach(findBounds);
}
findBounds(rootPos);

const padding = 40;
container.style.width = (maxX - minX + padding * 2) + 'px';
container.style.height = (maxY - minY + padding * 2) + 'px';

const offsetX = padding - minX;
const offsetY = padding - minY;

function drawConnections(pos) {
pos.children.forEach(child => {
const startX = pos.x + pos.width + offsetX;
const startY = pos.y + offsetY;
const endX = child.x + offsetX;
const endY = child.y + offsetY;
const midX = (startX + endX) / 2;

const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
let d = '';
if (template === 'minimal') {
d = `M ${startX} ${startY} L ${endX} ${endY}`;
} else {
d = `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`;
}

path.setAttribute('d', d);
path.setAttribute('stroke', scheme.gradient[pos.depth % scheme.gradient.length] + (template === 'capsule' ? '80' : '60'));
path.setAttribute('stroke-width', pos.depth === 0 ? 3 : 2);
path.setAttribute('fill', 'none');
svg.appendChild(path);

drawConnections(child);
});
}

function drawNodes(pos) {
const x = pos.x + offsetX;
const y = pos.y + offsetY;
const color = scheme.gradient[pos.depth % scheme.gradient.length];

const nodeEl = document.createElement('div');
nodeEl.className = `mindmap-node ${pos.depth === 0 ? 'root' : ''}`;
nodeEl.style.left = x + 'px';
nodeEl.style.top = (y - pos.height / 2) + 'px';
nodeEl.style.width = pos.width + 'px';
nodeEl.style.height = pos.height + 'px';
nodeEl.style.borderColor = color;
if (pos.depth === 0) nodeEl.style.backgroundColor = color;

const content = document.createElement('div');
content.className = 'node-content';
content.innerHTML = pos.text; 

nodeEl.appendChild(content);
container.appendChild(nodeEl);

// Safe LaTeX Rendering
try {
renderMathInElement(content, {
delimiters: [
{left: '$$', right: '$$', display: true},
{left: '$', right: '$', display: false},
{left: '\\(', right: '\\)', display: false},
{left: '\\[', right: '\\]', display: true}
],
throwOnError: false
});
} catch (e) {
console.warn("KaTeX rendering error for node:", pos.text, e);
}

pos.children.forEach(drawNodes);
}

drawConnections(rootPos);
drawNodes(rootPos);

const stats = getTreeStats(mindMapData);
document.getElementById('nodeCount').textContent = stats.nodes;
document.getElementById('depthCount').textContent = stats.maxDepth + 1;
document.getElementById('branchCount').textContent = stats.branches;

document.getElementById('emptyState').classList.add('hidden');
document.getElementById('canvasWrapper').classList.remove('hidden');
document.getElementById('downloadPng').disabled = false;
document.getElementById('downloadSvg').disabled = false;

currentZoom = 1;
updateZoom();
} catch (e) {
console.error("Render Error:", e);
showToast("渲染过程出错");
}
}

function saveHistory() {
const text = document.getElementById('inputText').value;
const template = document.getElementById('templateStyle').value;
const color = document.getElementById('colorScheme').value;
saveToHistory(text, template, color);
}

function updateZoom() {
const root = document.getElementById('mindMapRoot');
root.style.transform = `scale(${currentZoom})`;
}

function updateFsZoom() {
const root = document.getElementById('mindMapRootFs');
root.style.transform = `scale(${fsZoom})`;
document.getElementById('fsZoomLevel').textContent = Math.round(fsZoom * 100) + '%';
}

// Event Listeners
document.getElementById('settingsBtn').addEventListener('click', () => {
document.getElementById('settingsModal').classList.remove('hidden');
document.getElementById('settingsModal').classList.add('flex');
document.getElementById('apiKeyInput').value = apiKey;
});

document.getElementById('closeSettings').addEventListener('click', () => {
document.getElementById('settingsModal').classList.add('hidden');
});

document.getElementById('saveApiKey').addEventListener('click', () => {
apiKey = document.getElementById('apiKeyInput').value.trim();
if (cookieConsent) {
localStorage.setItem('chatglm_api_key', apiKey);
}
initApiStatus();
updateUIState();
document.getElementById('settingsModal').classList.add('hidden');
showToast('API Key 已保存');

// Auto-enable AI checkbox when key is saved
if(apiKey) {
document.getElementById('useAiCheckbox').checked = true;
updateUIState(); // Update UI to show enhance button
}
});

document.getElementById('aiEnhanceBtn').addEventListener('click', aiEnhanceContent);

document.getElementById('generateBtn').addEventListener('click', () => {
const text = document.getElementById('inputText').value.trim();
if (!text) {
showToast('请输入内容');
return;
}

const useAI = document.getElementById('useAiCheckbox').checked;

if (useAI) {
if (!apiKey) {
showToast('请先设置 API Key 或取消勾选 AI 功能');
} else {
aiGenerateMindMap();
}
} else {
// Local Mode
setLoading(true, '本地解析中...');
// Use setTimeout to allow UI to update before heavy processing
setTimeout(() => {
try {
mindMapData = parseMarkdown(text);
if (!mindMapData) {
showToast('无法解析内容，请检查格式');
return;
}
renderMindMapDOM();
saveHistory();
showToast('已生成（本地模式）');
} catch(e) {
console.error(e);
showToast('解析出错：' + e.message);
} finally {
// ENSURE loading is turned off
setLoading(false);
}
}, 50);
}
});

document.getElementById('exampleBtn').addEventListener('click', () => {
document.getElementById('inputText').value = exampleText;
showToast('已加载示例');
});

document.getElementById('clearBtn').addEventListener('click', () => {
document.getElementById('inputText').value = '';
document.getElementById('emptyState').classList.remove('hidden');
document.getElementById('canvasWrapper').classList.add('hidden');
mindMapData = null;
['nodeCount', 'depthCount', 'branchCount', 'charCount'].forEach(id => document.getElementById(id).textContent = '0');
});

// Export
document.getElementById('downloadPng').addEventListener('click', () => {
const node = document.getElementById('mindMapRoot');
htmlToImage.toPng(node)
.then(function (dataUrl) {
const link = document.createElement('a');
link.download = 'SAFmindmap.png';
link.href = dataUrl;
link.click();
showToast('PNG 已下载');
})
.catch(function (error) {
console.error('Export error:', error);
showToast('导出失败');
});
});

document.getElementById('downloadSvg').addEventListener('click', () => {
const node = document.getElementById('mindMapRoot');
htmlToImage.toSvgDataURL(node)
.then(function (dataUrl) {
const link = document.createElement('a');
link.download = 'SAFmindmap.svg';
link.href = dataUrl;
link.click();
showToast('SVG 已下载');
})
.catch(function (error) {
console.error('Export error:', error);
showToast('导出失败');
});
});

document.getElementById('zoomIn').addEventListener('click', () => { currentZoom = Math.min(currentZoom + 0.2, 3); updateZoom(); });
document.getElementById('zoomOut').addEventListener('click', () => { currentZoom = Math.max(currentZoom - 0.2, 0.3); updateZoom(); });
document.getElementById('resetZoom').addEventListener('click', () => { currentZoom = 1; updateZoom(); });

document.getElementById('maximizeBtn').addEventListener('click', () => {
if (!mindMapData) return;
document.getElementById('fullscreenModal').classList.remove('hidden');
renderMindMapDOM('mindMapRootFs', 'linesSvgFs');
fsZoom = 1;
updateFsZoom();
});

document.getElementById('closeFullscreen').addEventListener('click', () => document.getElementById('fullscreenModal').classList.add('hidden'));
document.getElementById('fsZoomIn').addEventListener('click', () => { fsZoom = Math.min(fsZoom + 0.2, 3); updateFsZoom(); });
document.getElementById('fsZoomOut').addEventListener('click', () => { fsZoom = Math.max(fsZoom - 0.2, 0.3); updateFsZoom(); });

document.getElementById('helpBtn').addEventListener('click', () => { document.getElementById('helpModal').classList.remove('hidden'); document.getElementById('helpModal').classList.add('flex'); });
document.getElementById('closeHelp').addEventListener('click', () => { document.getElementById('helpModal').classList.add('hidden'); document.getElementById('helpModal').classList.remove('flex'); });

document.getElementById('colorScheme').addEventListener('change', () => { if (mindMapData) renderMindMapDOM(); });
document.getElementById('templateStyle').addEventListener('change', () => { if (mindMapData) renderMindMapDOM(); });

document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
document.getElementById('fullscreenModal').classList.add('hidden');
document.getElementById('settingsModal').classList.add('hidden');
document.getElementById('helpModal').classList.add('hidden');
document.getElementById('historySidebar').classList.add('translate-x-full');
}
});

document.getElementById('inputText').addEventListener('input', (e) => {
document.getElementById('charCount').textContent = e.target.value.length;
});

// Init
init();
</script>
</body>
</html>
